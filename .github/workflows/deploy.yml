name: CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  PROJECT_ID: short-term-trade
  REGION: us-central1
  ZONE: us-central1-a
  AR_REPO: tqqq
  IMAGE_NAME: bot
  INSTANCE_NAME: tqqq-trading-bot

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Build with Cloud Build
        run: |
          # Submit build asynchronously to avoid log streaming permission issues
          BUILD_ID=$(gcloud builds submit \
            --config=cloudbuild.yaml \
            --substitutions=_IMAGE_URL=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --project=${{ env.PROJECT_ID }} \
            --gcs-source-staging-dir=gs://${{ env.PROJECT_ID }}_cloudbuild/source \
            --async \
            --format='value(id)')

          echo "Build ID: $BUILD_ID"

          # Wait for build to complete
          while true; do
            STATUS=$(gcloud builds describe $BUILD_ID --project=${{ env.PROJECT_ID }} --format='value(status)')
            echo "Build status: $STATUS"

            if [ "$STATUS" = "SUCCESS" ]; then
              echo "Build completed successfully!"
              break
            elif [ "$STATUS" = "FAILURE" ] || [ "$STATUS" = "TIMEOUT" ] || [ "$STATUS" = "CANCELLED" ]; then
              echo "Build failed with status: $STATUS"
              exit 1
            fi

            sleep 10
          done

      - name: Tag and push as latest
        run: |
          # Configure docker to authenticate with Artifact Registry
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

          # Pull the SHA-tagged image, tag as latest, and push
          docker pull ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker tag ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.IMAGE_NAME }}:latest

      - name: Deploy to GCE
        run: |
          # Use startup-script metadata to trigger update on next boot/reset
          gcloud compute instances add-metadata ${{ env.INSTANCE_NAME }} \
            --zone=${{ env.ZONE }} \
            --metadata=deploy-version=${{ github.sha }}

          # Reset instance to apply changes (triggers systemd to pull new image)
          gcloud compute instances reset ${{ env.INSTANCE_NAME }} \
            --zone=${{ env.ZONE }}

          echo "Instance reset triggered. Waiting for startup..."
          sleep 60

      - name: Verify deployment
        run: |
          # Check instance status
          STATUS=$(gcloud compute instances describe ${{ env.INSTANCE_NAME }} \
            --zone=${{ env.ZONE }} \
            --format="value(status)")
          echo "Instance status: $STATUS"

          if [ "$STATUS" != "RUNNING" ]; then
            echo "Instance is not running!"
            exit 1
          fi
          echo "Deployment complete. Instance is running."
